"""
å› æœåˆ†ææ™ºèƒ½ä½“ç³»ç»Ÿ - æ¼”ç¤ºè„šæœ¬
å±•ç¤ºä¸‰ç§å…¸å‹ä½¿ç”¨åœºæ™¯ï¼šå½’å› åˆ†æã€å¹²é¢„åˆ†æã€åäº‹å®åˆ†æ

åº”ç”¨åœºæ™¯ï¼šæœºåˆ¶ç ‚ç”Ÿäº§è´¨é‡æ§åˆ¶ä¸å·¥è‰ºä¼˜åŒ–
"""

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), 'src'))

import pandas as pd
import warnings
from dotenv import load_dotenv

warnings.filterwarnings('ignore')

# åŠ è½½ .env é…ç½®
load_dotenv()

# æ£€æŸ¥ API Key
if not os.getenv('OPENAI_API_KEY'):
    print("âš ï¸  é”™è¯¯ï¼šæœªæ‰¾åˆ° OPENAI_API_KEY")
    print("   è¯·ç¡®ä¿ .env æ–‡ä»¶å­˜åœ¨ä¸”åŒ…å«æ­£ç¡®çš„é…ç½®")
    sys.exit(1)

print(f"âœ“ ä½¿ç”¨æ¨¡å‹: {os.getenv('OPENAI_MODEL', 'gpt-4o-mini')}")
print(f"âœ“ APIåœ°å€: {os.getenv('OPENAI_API_BASE', 'default')}")
print()

from src.causal_agent_system import (
    initialize_causal_model,
    create_causal_agent_graph
)

print("=" * 100)
print("ğŸš€ å› æœé©±åŠ¨çš„æ™ºèƒ½ä½“ç³»ç»Ÿ - æ··å‡åœŸé…åˆæ¯”ä¼˜åŒ–åº”ç”¨")
print("=" * 100)
print()
print("ç³»ç»Ÿæ¶æ„ï¼š")
print("  1ï¸âƒ£  Router Agent       - ç†è§£ç”¨æˆ·é—®é¢˜ï¼Œè¯†åˆ«åˆ†æç±»å‹")
print("  2ï¸âƒ£  Causal Analyst    - æ‰§è¡Œå› æœæ¨ç†åˆ†æ")
print("  3ï¸âƒ£  Advisor Agent     - ç”Ÿæˆå†³ç­–å»ºè®®")
print()
print("åº”ç”¨é¢†åŸŸï¼šé«˜æ€§èƒ½æ··å‡åœŸé…åˆæ¯”è®¾è®¡ä¸å¼ºåº¦ä¼˜åŒ–")
print("æ•°æ®æ¥æºï¼šUCI Machine Learning Repository (Yeh 1998, 1030ä¸ªçœŸå®æ ·æœ¬)")
print("=" * 100)
print()

# ============================================================================
# ç¬¬ä¸€æ­¥ï¼šåŠ è½½æ•°æ®å¹¶åˆå§‹åŒ–å› æœæ¨¡å‹
# ============================================================================

print("ğŸ”§ åˆå§‹åŒ–å› æœæ¨¡å‹...")
try:
    # ä¼˜å…ˆä»ç¼“å­˜åŠ è½½
    causal_model = initialize_causal_model()
    print()
except ValueError as e:
    # å¦‚æœç¼“å­˜ä¸å­˜åœ¨ï¼ŒåŠ è½½æ•°æ®å¹¶è®­ç»ƒ
    print("âš ï¸  æœªæ‰¾åˆ°ç¼“å­˜æ¨¡å‹ï¼Œæ­£åœ¨è®­ç»ƒ...")
    print("ğŸ“¦ åŠ è½½çœŸå®æ··å‡åœŸæ•°æ®ï¼ˆUCIæ•°æ®é›†ï¼‰...")
    df = pd.read_csv('data/real/concrete_compressive_strength.csv')
    df.columns = df.columns.str.strip()
    print(f"âœ“ æ•°æ®åŠ è½½å®Œæˆï¼š{len(df)} æ¡è®°å½•")
    print(f"âœ“ æ•°æ®ç‰¹å¾ï¼š{len(df.columns)} ä¸ªå˜é‡")
    print()
    causal_model = initialize_causal_model(df)
    print()
    print("ğŸ’¡ æç¤ºï¼šä¸‹æ¬¡è¿è¡Œå°†ç›´æ¥ä½¿ç”¨ç¼“å­˜ï¼Œå¯åŠ¨æ›´å¿«ï¼")
    print()

# ============================================================================
# ç¬¬äºŒæ­¥ï¼šåˆ›å»ºæ™ºèƒ½ä½“å·¥ä½œæµ
# ============================================================================

print("ğŸ—ï¸  æ„å»ºæ™ºèƒ½ä½“å·¥ä½œæµ...")
agent_graph = create_causal_agent_graph()
print("âœ“ å·¥ä½œæµæ„å»ºå®Œæˆ")
print()

# ============================================================================
# ç¬¬ä¸‰æ­¥ï¼šå±•ç¤ºä¸‰ç§å…¸å‹åœºæ™¯
# ============================================================================

print("=" * 100)
print("ğŸ“š å…¸å‹åº”ç”¨åœºæ™¯æ¼”ç¤º")
print("=" * 100)
print()

# ------------------------------------------------------------------------
# åœºæ™¯1ï¼šå½’å› åˆ†æ - "ä¸ºä»€ä¹ˆå«æ³¥é‡è¶…æ ‡äº†ï¼Ÿ"
# ------------------------------------------------------------------------

print("\n" + "ğŸ”" * 50)
print("åœºæ™¯ 1ï¼šå½’å› åˆ†æ - è´¨é‡é—®é¢˜è¯Šæ–­")
print("ğŸ”" * 50)
print()

query_1 = "æœ€è¿‘æ··å‡åœŸæŠ—å‹å¼ºåº¦æ˜æ˜¾ä¸‹é™ï¼Œè¯·å¸®æˆ‘åˆ†æä¸€ä¸‹ä¸»è¦åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ"
print(f"ğŸ‘¤ ç”¨æˆ·é—®é¢˜ï¼š{query_1}")
print()

try:
    result_1 = agent_graph.invoke({
        "user_query": query_1
    })
    
    print("\n" + "=" * 100)
    print("ğŸ“Š æœ€ç»ˆç»“æœ")
    print("=" * 100)
    print(f"\nğŸ¯ åˆ†æç±»å‹: {result_1['analysis_type']}")
    print(f"ğŸ“ˆ ç›®æ ‡å˜é‡: {result_1['target_variable']}")
    print(f"\nğŸ’¡ å†³ç­–å»ºè®®:\n{result_1['recommendations']}")
    print()
    
except Exception as e:
    print(f"âŒ åœºæ™¯1æ‰§è¡Œå¤±è´¥: {e}")
    import traceback
    traceback.print_exc()

print("\n" + "â¸ï¸ " * 50)
input("æŒ‰å›è½¦é”®ç»§ç»­ä¸‹ä¸€ä¸ªåœºæ™¯...")

# ------------------------------------------------------------------------
# åœºæ™¯2ï¼šå¹²é¢„åˆ†æ - "å¦‚ä½•æé«˜æ··å‡åœŸå¼ºåº¦ï¼Ÿ"
# ------------------------------------------------------------------------

print("\n" + "ğŸ”§" * 50)
print("åœºæ™¯ 2ï¼šå¹²é¢„åˆ†æ - å·¥è‰ºä¼˜åŒ–")
print("ğŸ”§" * 50)
print()

query_2 = "æˆ‘éœ€è¦æé«˜æ··å‡åœŸæŠ—å‹å¼ºåº¦ï¼Œè¯·åˆ†æå“ªäº›é…åˆæ¯”å‚æ•°è°ƒæ•´æœ€æœ‰æ•ˆï¼Ÿ"
print(f"ğŸ‘¤ ç”¨æˆ·é—®é¢˜ï¼š{query_2}")
print()

try:
    result_2 = agent_graph.invoke({
        "user_query": query_2
    })
    
    print("\n" + "=" * 100)
    print("ğŸ“Š æœ€ç»ˆç»“æœ")
    print("=" * 100)
    print(f"\nğŸ¯ åˆ†æç±»å‹: {result_2['analysis_type']}")
    print(f"ğŸ“ˆ ç›®æ ‡å˜é‡: {result_2['target_variable']}")
    print(f"\nğŸ’¡ å†³ç­–å»ºè®®:\n{result_2['recommendations']}")
    print()
    
except Exception as e:
    print(f"âŒ åœºæ™¯2æ‰§è¡Œå¤±è´¥: {e}")
    import traceback
    traceback.print_exc()

print("\n" + "â¸ï¸ " * 50)
input("æŒ‰å›è½¦é”®ç»§ç»­ä¸‹ä¸€ä¸ªåœºæ™¯...")

# ------------------------------------------------------------------------
# åœºæ™¯3ï¼šåäº‹å®åˆ†æ - "å¦‚æœè°ƒæ•´æ°´èƒ¶æ¯”ä¼šæ€æ ·ï¼Ÿ"
# ------------------------------------------------------------------------

print("\n" + "ğŸ”®" * 50)
print("åœºæ™¯ 3ï¼šåäº‹å®åˆ†æ - æ•ˆæœé¢„æµ‹")
print("ğŸ”®" * 50)
print()

query_3 = "å¦‚æœæŠŠæ°´ç”¨é‡ä»200é™ä½åˆ°150 kg/mÂ³ï¼Œæ··å‡åœŸå¼ºåº¦ä¼šæå‡å¤šå°‘ï¼Ÿ"
print(f"ğŸ‘¤ ç”¨æˆ·é—®é¢˜ï¼š{query_3}")
print()

try:
    result_3 = agent_graph.invoke({
        "user_query": query_3
    })
    
    print("\n" + "=" * 100)
    print("ğŸ“Š æœ€ç»ˆç»“æœ")
    print("=" * 100)
    print(f"\nğŸ¯ åˆ†æç±»å‹: {result_3['analysis_type']}")
    print(f"ğŸ“ˆ ç›®æ ‡å˜é‡: {result_3['target_variable']}")
    print(f"\nğŸ’¡ å†³ç­–å»ºè®®:\n{result_3['recommendations']}")
    print()
    
except Exception as e:
    print(f"âŒ åœºæ™¯3æ‰§è¡Œå¤±è´¥: {e}")
    import traceback
    traceback.print_exc()

# ============================================================================
# æ€»ç»“
# ============================================================================

print("\n" + "=" * 100)
print("âœ¨ æ¼”ç¤ºå®Œæˆ")
print("=" * 100)
print()
print("ç³»ç»Ÿæ ¸å¿ƒèƒ½åŠ›ï¼š")
print("  âœ“ è‡ªç„¶è¯­è¨€ç†è§£ - æ— éœ€ç¼–å†™ä»£ç ï¼Œç›´æ¥æé—®")
print("  âœ“ æ™ºèƒ½è·¯ç”±å†³ç­– - è‡ªåŠ¨è¯†åˆ«é—®é¢˜ç±»å‹å¹¶é€‰æ‹©åˆé€‚çš„åˆ†ææ–¹æ³•")
print("  âœ“ å› æœæ¨ç†åˆ†æ - åŸºäºä¸¥æ ¼çš„å› æœæ¨æ–­ï¼Œè€Œéç®€å•çš„ç›¸å…³æ€§")
print("  âœ“ å¯æ“ä½œå»ºè®®  - æä¾›å…·ä½“çš„å·¥è‰ºä¼˜åŒ–æ–¹æ¡ˆ")
print()
print("åº”ç”¨ä»·å€¼ï¼š")
print("  ğŸ’° é™ä½è¯•é”™æˆæœ¬ - é€šè¿‡åäº‹å®åˆ†æé¢„æµ‹æ”¹è¿›æ•ˆæœï¼Œæ— éœ€å®é™…è¯•éªŒ")
print("  âš¡ åŠ å¿«å†³ç­–é€Ÿåº¦ - ä»é—®é¢˜åˆ°å»ºè®®å…¨æµç¨‹è‡ªåŠ¨åŒ–")
print("  ğŸ¯ ç²¾å‡†å®šä½åŸå›  - å½’å› åˆ†ææ‰¾å‡ºè´¨é‡é—®é¢˜æ ¹æº")
print("  ğŸ“ˆ é‡åŒ–æ”¹è¿›æ”¶ç›Š - å¹²é¢„åˆ†æè¯„ä¼°å„æ–¹æ¡ˆæ•ˆæœ")
print()
print("å…¸å‹åº”ç”¨åœºæ™¯ï¼š")
print("  ğŸ­ æœºåˆ¶ç ‚å«æ³¥é‡æ§åˆ¶ - \"å¦‚ä½•å°†å«æ³¥é‡ä»2.1%é™è‡³1.5%ä»¥ä¸‹ï¼Ÿ\"")
print("  ğŸ”¨ æ··å‡åœŸå¼ºåº¦ä¼˜åŒ–   - \"å“ªäº›é…åˆæ¯”å‚æ•°å¯¹å¼ºåº¦å½±å“æœ€å¤§ï¼Ÿ\"")
print("  ğŸ›ï¸  å·¥è‰ºå‚æ•°è°ƒä¼˜     - \"æ°´æ´—æ—¶é•¿å’Œç­›æŒ¯å¹…å¦‚ä½•é…åˆæœ€ä¼˜ï¼Ÿ\"")
print("  ğŸ“Š ä¾›åº”å•†è¯„ä¼°       - \"æ›´æ¢é›†æ–™äº§åœ°ä¼šå¯¹è´¨é‡äº§ç”Ÿä»€ä¹ˆå½±å“ï¼Ÿ\"")
print()
print("=" * 100)

