<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å› æœåˆ†æ API æµ‹è¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }
        
        .panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
        }
        
        .panel h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 8px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }
        
        .checkbox-item label {
            margin-bottom: 0 !important;
            cursor: pointer;
            font-weight: normal !important;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        
        button {
            flex: 1;
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .result-panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            min-height: 400px;
        }
        
        .result-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .result-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-item h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .result-item pre {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }
        
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(3, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .error {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            color: #856404;
            margin-top: 15px;
        }
        
        .success {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 15px;
            color: #155724;
            margin-top: 15px;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .config-item {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .config-item strong {
            color: #667eea;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª å› æœåˆ†æ API æµ‹è¯•å·¥å…·</h1>
            <p>æµ‹è¯• /api/analyze ç«¯ç‚¹ - æ”¯æŒå½’å› ã€å¹²é¢„ã€åäº‹å®åˆ†æ</p>
        </div>
        
        <div class="content">
            <!-- å·¦ä¾§ï¼šè¾“å…¥è¡¨å• -->
            <div class="panel">
                <h2>ğŸ“ é…ç½®è¯·æ±‚å‚æ•°</h2>
                
                <div class="info-box">
                    ğŸ’¡ <strong>æç¤ºï¼š</strong>æ‰€æœ‰å‚æ•°å‡ä¸ºå¯é€‰ï¼ˆé™¤äº†queryï¼‰ã€‚æ ¹æ®æ‚¨çš„æŸ¥è¯¢ç±»å‹é€‰æ‹©åˆé€‚çš„å‚æ•°ã€‚
                </div>
                
                <!-- åŸºç¡€å‚æ•° -->
                <div class="form-group">
                    <label>ğŸ” ç”¨æˆ·æŸ¥è¯¢ *</label>
                    <textarea id="query" placeholder="ä¾‹å¦‚ï¼šå¦‚ä½•é€šè¿‡è°ƒæ•´æ°´æ³¥å’Œç²‰ç…¤ç°ä½¿å¼ºåº¦è¾¾åˆ°45 MPaï¼Ÿ"></textarea>
                </div>
                
                <!-- æ ‡ç­¾åˆ‡æ¢ -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('basic')">åŸºç¡€å‚æ•°</button>
                    <button class="tab" onclick="switchTab('config')">è§‚æµ‹é…æ¯”</button>
                    <button class="tab" onclick="switchTab('advanced')">é«˜çº§é€‰é¡¹</button>
                </div>
                
                <!-- åŸºç¡€å‚æ•°æ ‡ç­¾ -->
                <div id="basic-tab" class="tab-content active">
                    <div class="form-group">
                        <label>ğŸ¯ ç›®æ ‡å¼ºåº¦ (MPa)</label>
                        <input type="number" id="targetStrength" placeholder="ä¾‹å¦‚ï¼š45" step="0.1">
                        <small style="color: #666; font-size: 12px;">ç”¨äºå¹²é¢„åˆ†æï¼ŒæŒ‡å®šæœŸæœ›è¾¾åˆ°çš„å¼ºåº¦å€¼</small>
                    </div>
                    
                    <div class="form-group">
                        <label>ğŸ”§ è°ƒæ•´å˜é‡ï¼ˆå¯å¤šé€‰ï¼‰</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="adj_cement" value="cement">
                                <label for="adj_cement">æ°´æ³¥</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="adj_bfs" value="blast_furnace_slag">
                                <label for="adj_bfs">é«˜ç‚‰çŸ¿æ¸£</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="adj_fly" value="fly_ash">
                                <label for="adj_fly">ç²‰ç…¤ç°</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="adj_water" value="water">
                                <label for="adj_water">æ°´</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="adj_sp" value="superplasticizer">
                                <label for="adj_sp">å‡æ°´å‰‚</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="adj_ca" value="coarse_aggregate">
                                <label for="adj_ca">ç²—éª¨æ–™</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="adj_fa" value="fine_aggregate">
                                <label for="adj_fa">ç»†éª¨æ–™</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="adj_age" value="age">
                                <label for="adj_age">é¾„æœŸ</label>
                            </div>
                        </div>
                        <small style="color: #666; font-size: 12px;">ç”¨äºå¹²é¢„åˆ†æï¼ŒæŒ‡å®šå…è®¸è°ƒæ•´çš„å˜é‡</small>
                    </div>
                    
                    <div class="form-group">
                        <label>ğŸ“ å‚è€ƒæ‰¹æ¬¡ç´¢å¼•</label>
                        <input type="number" id="refIndex" placeholder="ä¾‹å¦‚ï¼š100" min="0" max="1029">
                        <small style="color: #666; font-size: 12px;">ç”¨äºåäº‹å®åˆ†æï¼Œé€‰æ‹©ä¸€ä¸ªçœŸå®æ ·æœ¬ä½œä¸ºåŸºå‡†ï¼ˆ0-1029ï¼‰</small>
                    </div>
                </div>
                
                <!-- è§‚æµ‹é…æ¯”æ ‡ç­¾ -->
                <div id="config-tab" class="tab-content">
                    <div class="info-box">
                        ğŸ“‹ è¾“å…¥ä¸€ä¸ªå®Œæ•´çš„æ··å‡åœŸé…æ¯”ä½œä¸ºåŸºå‡†ã€‚ç”¨äºåäº‹å®åˆ†ææˆ–å¹²é¢„åˆ†æçš„èµ·ç‚¹ã€‚
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>æ°´æ³¥ (kg/mÂ³)</label>
                            <input type="number" id="cement" placeholder="280" step="1">
                        </div>
                        <div class="form-group">
                            <label>é«˜ç‚‰çŸ¿æ¸£ (kg/mÂ³)</label>
                            <input type="number" id="bfs" placeholder="0" step="1">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>ç²‰ç…¤ç° (kg/mÂ³)</label>
                            <input type="number" id="flyAsh" placeholder="0" step="1">
                        </div>
                        <div class="form-group">
                            <label>æ°´ (kg/mÂ³)</label>
                            <input type="number" id="water" placeholder="180" step="1">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>é«˜æ•ˆå‡æ°´å‰‚ (kg/mÂ³)</label>
                            <input type="number" id="sp" placeholder="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>ç²—éª¨æ–™ (kg/mÂ³)</label>
                            <input type="number" id="ca" placeholder="1000" step="1">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>ç»†éª¨æ–™ (kg/mÂ³)</label>
                            <input type="number" id="fa" placeholder="800" step="1">
                        </div>
                        <div class="form-group">
                            <label>é¾„æœŸ (å¤©)</label>
                            <input type="number" id="age" placeholder="28" min="1" max="365">
                        </div>
                    </div>
                </div>
                
                <!-- é«˜çº§é€‰é¡¹æ ‡ç­¾ -->
                <div id="advanced-tab" class="tab-content">
                    <div class="form-group">
                        <label>ğŸŒ API ç«¯ç‚¹</label>
                        <input type="text" id="apiUrl" value="http://localhost:8000/api/analyze">
                    </div>
                    
                    <div class="form-group">
                        <label>â±ï¸ è¯·æ±‚è¶…æ—¶ (ç§’)</label>
                        <input type="number" id="timeout" value="180" min="10" max="600">
                        <small style="color: #666; font-size: 12px;">å¹²é¢„åˆ†æé€šå¸¸éœ€è¦1-3åˆ†é’Ÿï¼Œå»ºè®®è®¾ç½®180ç§’ä»¥ä¸Š</small>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn-primary" onclick="sendStreamRequest()">ğŸš€ æµå¼åˆ†æï¼ˆæ¨èï¼‰</button>
                    <button class="btn-primary" onclick="sendRequest()" style="background: #6c757d;">ğŸ“¦ æ™®é€šè¯·æ±‚</button>
                    <button class="btn-secondary" onclick="clearForm()">ğŸ”„ é‡ç½®</button>
                    <button class="btn-success" onclick="loadExample()">ğŸ“‹ ç¤ºä¾‹</button>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šç»“æœå±•ç¤º -->
            <div class="panel">
                <h2>ğŸ“Š å“åº”ç»“æœ</h2>
                <div id="result" class="result-content">
                    <p style="color: #999; text-align: center; padding: 40px;">
                        è¯·é…ç½®å‚æ•°å¹¶å‘é€è¯·æ±‚
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // æ ‡ç­¾åˆ‡æ¢
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        // å‘é€è¯·æ±‚
        async function sendRequest() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <div class="loading">
                    æ­£åœ¨åˆ†æ<br>
                    <small style="color: #999; font-size: 13px; margin-top: 10px; display: block;">
                        â±ï¸ å¹²é¢„åˆ†æé€šå¸¸éœ€è¦1-3åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…...
                    </small>
                </div>
            `;
            
            try {
                // æ„å»ºè¯·æ±‚ä½“
                const requestBody = {
                    query: document.getElementById('query').value
                };
                
                // æ·»åŠ å‚è€ƒç´¢å¼•ï¼ˆå¦‚æœå¡«å†™ï¼‰
                const refIndex = document.getElementById('refIndex').value;
                if (refIndex) {
                    requestBody.reference_sample_index = parseInt(refIndex);
                }
                
                // æ·»åŠ ç›®æ ‡å¼ºåº¦ï¼ˆå¦‚æœå¡«å†™ï¼‰
                const targetStrength = document.getElementById('targetStrength').value;
                if (targetStrength) {
                    requestBody.target_strength = parseFloat(targetStrength);
                }
                
                // æ·»åŠ è°ƒæ•´å˜é‡ï¼ˆå¦‚æœé€‰ä¸­ï¼‰
                const adjustFactors = [];
                document.querySelectorAll('.checkbox-item input[type="checkbox"]:checked').forEach(cb => {
                    adjustFactors.push(cb.value);
                });
                if (adjustFactors.length > 0) {
                    requestBody.adjust_factors = adjustFactors;
                }
                
                // æ·»åŠ è§‚æµ‹é…æ¯”ï¼ˆå¦‚æœå¡«å†™ï¼‰
                const cement = document.getElementById('cement').value;
                if (cement) {
                    requestBody.observed_config = {
                        cement: parseFloat(cement),
                        blast_furnace_slag: parseFloat(document.getElementById('bfs').value) || 0,
                        fly_ash: parseFloat(document.getElementById('flyAsh').value) || 0,
                        water: parseFloat(document.getElementById('water').value) || 180,
                        superplasticizer: parseFloat(document.getElementById('sp').value) || 0,
                        coarse_aggregate: parseFloat(document.getElementById('ca').value) || 1000,
                        fine_aggregate: parseFloat(document.getElementById('fa').value) || 800,
                        age: parseInt(document.getElementById('age').value) || 28
                    };
                }
                
                // éªŒè¯
                if (!requestBody.query) {
                    resultDiv.innerHTML = '<div class="error">âŒ è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹</div>';
                    return;
                }
                
                // å‘é€è¯·æ±‚
                const apiUrl = document.getElementById('apiUrl').value;
                const timeout = parseInt(document.getElementById('timeout').value) * 1000;
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                displayResult(data, requestBody);
                
            } catch (error) {
                let errorHtml = `
                    <div class="error">
                        <h3>âŒ è¯·æ±‚å¤±è´¥</h3>
                        <p><strong>é”™è¯¯ä¿¡æ¯ï¼š</strong>${error.message}</p>
                `;
                
                // æ£€æµ‹æ˜¯å¦æ˜¯è¶…æ—¶é”™è¯¯
                if (error.name === 'AbortError' || error.message.includes('aborted')) {
                    errorHtml += `
                        <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 4px;">
                            <strong>â±ï¸ è¯·æ±‚è¶…æ—¶</strong>
                            <p style="margin: 5px 0;">å¹²é¢„åˆ†æé€šå¸¸éœ€è¦1-3åˆ†é’Ÿå®Œæˆã€‚è¯·å°è¯•ï¼š</p>
                            <ul style="margin: 5px 0 0 20px;">
                                <li>å¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆé«˜çº§é€‰é¡¹ â†’ è¯·æ±‚è¶…æ—¶ï¼Œå»ºè®®è®¾ç½®ä¸º180-300ç§’ï¼‰</li>
                                <li>åˆ·æ–°é¡µé¢é‡è¯•ï¼ŒæœåŠ¡å™¨å¯èƒ½å·²ç»å®Œæˆåˆ†æ</li>
                                <li>æ£€æŸ¥ç»ˆç«¯æ—¥å¿—ï¼ŒæŸ¥çœ‹åˆ†æè¿›åº¦</li>
                            </ul>
                        </div>
                    `;
                } else {
                    errorHtml += `
                        <p style="font-size: 12px; margin-top: 10px;">
                            ğŸ’¡ <strong>å¸¸è§é—®é¢˜ï¼š</strong><br>
                            â€¢ è¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼ˆpython api_server.pyï¼‰<br>
                            â€¢ æ£€æŸ¥APIç«¯ç‚¹æ˜¯å¦æ­£ç¡®ï¼ˆé»˜è®¤ï¼šhttp://localhost:8000/api/analyzeï¼‰<br>
                            â€¢ æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°å’Œç»ˆç«¯æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
                        </p>
                    `;
                }
                
                errorHtml += `</div>`;
                resultDiv.innerHTML = errorHtml;
            }
        }
        
        // æµå¼è¯·æ±‚ï¼ˆä½¿ç”¨ Server-Sent Eventsï¼‰
        async function sendStreamRequest() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <div class="loading">
                    æ­£åœ¨è¿æ¥åˆ°æœåŠ¡å™¨<br>
                    <small style="color: #999; font-size: 13px; margin-top: 10px; display: block;">
                        â±ï¸ å°†å®æ—¶æ˜¾ç¤ºåˆ†æè¿›åº¦...
                    </small>
                </div>
            `;
            
            try {
                // æ„å»ºè¯·æ±‚ä½“ï¼ˆä¸æ™®é€šè¯·æ±‚ç›¸åŒï¼‰
                const requestBody = {
                    query: document.getElementById('query').value
                };
                
                const refIndex = document.getElementById('refIndex').value;
                if (refIndex) {
                    requestBody.reference_sample_index = parseInt(refIndex);
                }
                
                const targetStrength = document.getElementById('targetStrength').value;
                if (targetStrength) {
                    requestBody.target_strength = parseFloat(targetStrength);
                }
                
                const adjustFactors = [];
                document.querySelectorAll('.checkbox-item input[type="checkbox"]:checked').forEach(cb => {
                    adjustFactors.push(cb.value);
                });
                if (adjustFactors.length > 0) {
                    requestBody.adjust_factors = adjustFactors;
                }
                
                const cement = document.getElementById('cement').value;
                if (cement) {
                    requestBody.observed_config = {
                        cement: parseFloat(cement),
                        blast_furnace_slag: parseFloat(document.getElementById('bfs').value) || 0,
                        fly_ash: parseFloat(document.getElementById('flyAsh').value) || 0,
                        water: parseFloat(document.getElementById('water').value) || 180,
                        superplasticizer: parseFloat(document.getElementById('sp').value) || 0,
                        coarse_aggregate: parseFloat(document.getElementById('ca').value) || 1000,
                        fine_aggregate: parseFloat(document.getElementById('fa').value) || 1000,
                        age: parseInt(document.getElementById('age').value) || 28
                    };
                }
                
                if (!requestBody.query) {
                    resultDiv.innerHTML = '<div class="error">âŒ è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹</div>';
                    return;
                }
                
                // æ˜¾ç¤ºè¿›åº¦æ—¥å¿—
                let progressHtml = `
                    <div class="success">ğŸ”„ æ­£åœ¨å®æ—¶åˆ†æ...</div>
                    <div class="result-item">
                        <h3>ğŸ“¤ è¯·æ±‚å‚æ•°</h3>
                        <pre>${JSON.stringify(requestBody, null, 2)}</pre>
                    </div>
                    <div class="result-item">
                        <h3>ğŸ“¡ å®æ—¶è¿›åº¦</h3>
                        <div id="progress-log" style="background: #f5f5f5; padding: 15px; border-radius: 6px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 13px; line-height: 1.8;">
                        </div>
                    </div>
                `;
                resultDiv.innerHTML = progressHtml;
                
                const progressLog = document.getElementById('progress-log');
                
                // åˆ›å»º EventSource
                const apiUrl = document.getElementById('apiUrl').value.replace('/analyze', '/analyze_stream');
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                let buffer = '';
                let finalResult = null;
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    
                    // å¤„ç† SSE æ¶ˆæ¯
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop(); // ä¿ç•™ä¸å®Œæ•´çš„è¡Œ
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));
                            
                            if (data.type === 'start') {
                                progressLog.innerHTML += `<div style="color: #667eea; font-weight: bold;">â–¶ï¸ ${data.message}</div>`;
                            } else if (data.type === 'progress') {
                                progressLog.innerHTML += `<div style="color: #555;">${data.message}</div>`;
                                progressLog.scrollTop = progressLog.scrollHeight;
                            } else if (data.type === 'result') {
                                finalResult = data.data;
                            } else if (data.type === 'end') {
                                progressLog.innerHTML += `<div style="color: #28a745; font-weight: bold; margin-top: 10px;">âœ… ${data.message}</div>`;
                            } else if (data.type === 'error') {
                                progressLog.innerHTML += `<div style="color: #dc3545; font-weight: bold;">âŒ ${data.message}</div>`;
                            }
                        }
                    }
                }
                
                // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
                if (finalResult) {
                    displayResult(finalResult, requestBody);
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>âŒ æµå¼è¯·æ±‚å¤±è´¥</h3>
                        <p><strong>é”™è¯¯ä¿¡æ¯ï¼š</strong>${error.message}</p>
                        <p style="font-size: 12px; margin-top: 10px;">
                            ğŸ’¡ <strong>æç¤ºï¼š</strong><br>
                            â€¢ è¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ<br>
                            â€¢ æµå¼æ¥å£ï¼š/api/analyze_stream<br>
                            â€¢ å¦‚æœæµå¼å¤±è´¥ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨æ™®é€šè¯·æ±‚æŒ‰é’®
                        </p>
                    </div>
                `;
            }
        }
        
        // æ˜¾ç¤ºç»“æœ
        function displayResult(data, requestBody) {
            const resultDiv = document.getElementById('result');
            
            let html = '<div class="success">âœ… åˆ†ææˆåŠŸ</div>';
            
            // è¯·æ±‚æ‘˜è¦
            html += '<div class="result-item">';
            html += '<h3>ğŸ“¤ è¯·æ±‚å‚æ•°</h3>';
            html += `<pre>${JSON.stringify(requestBody, null, 2)}</pre>`;
            html += '</div>';
            
            // åˆ†æç±»å‹
            html += '<div class="result-item">';
            html += '<h3>ğŸ” åˆ†æç±»å‹</h3>';
            html += `<p><strong>${data.analysis_type}</strong></p>`;
            html += `<p style="font-size: 13px; color: #666; margin-top: 5px;">${data.routing_reasoning}</p>`;
            html += '</div>';
            
            // ç›®æ ‡å˜é‡
            html += '<div class="result-item">';
            html += '<h3>ğŸ¯ ç›®æ ‡å˜é‡</h3>';
            html += `<p><strong>${data.target_variable}</strong></p>`;
            html += '</div>';
            
            // å› æœåˆ†æç»“æœ
            html += '<div class="result-item">';
            html += '<h3>ğŸ“Š å› æœåˆ†æç»“æœ</h3>';
            html += `<pre>${JSON.stringify(data.causal_results, null, 2)}</pre>`;
            html += '</div>';
            
            // åˆ†ææ‘˜è¦
            html += '<div class="result-item">';
            html += '<h3>ğŸ“ åˆ†ææ‘˜è¦</h3>';
            html += `<p style="line-height: 1.8;">${data.analysis_summary}</p>`;
            html += '</div>';
            
            // ä¼˜åŒ–é…æ¯”ï¼ˆå¦‚æœæœ‰ï¼‰
            if (data.optimized_config) {
                html += '<div class="result-item">';
                html += '<h3>ğŸ”§ ä¼˜åŒ–é…æ¯”æ–¹æ¡ˆ</h3>';
                html += '<div class="config-grid">';
                for (const [key, value] of Object.entries(data.optimized_config)) {
                    if (key !== 'concrete_compressive_strength') {
                        html += `<div class="config-item"><strong>${formatVarName(key)}:</strong> ${value.toFixed(1)}</div>`;
                    }
                }
                html += '</div>';
                if (data.predicted_strength) {
                    html += `<p style="margin-top: 15px; font-size: 16px;"><strong>é¢„æµ‹å¼ºåº¦ï¼š</strong> <span style="color: #28a745; font-size: 20px;">${data.predicted_strength.toFixed(2)} MPa</span></p>`;
                }
                if (data.optimization_summary) {
                    html += `<pre style="margin-top: 10px;">${data.optimization_summary}</pre>`;
                }
                html += '</div>';
            }
            
            // å†³ç­–å»ºè®®
            html += '<div class="result-item">';
            html += '<h3>ğŸ’¡ å†³ç­–å»ºè®®</h3>';
            html += `<div style="line-height: 1.8; white-space: pre-wrap;">${data.recommendations}</div>`;
            html += '</div>';
            
            resultDiv.innerHTML = html;
        }
        
        // å˜é‡åæ ¼å¼åŒ–
        function formatVarName(name) {
            const nameMap = {
                'cement': 'æ°´æ³¥',
                'blast_furnace_slag': 'é«˜ç‚‰çŸ¿æ¸£',
                'fly_ash': 'ç²‰ç…¤ç°',
                'water': 'æ°´',
                'superplasticizer': 'å‡æ°´å‰‚',
                'coarse_aggregate': 'ç²—éª¨æ–™',
                'fine_aggregate': 'ç»†éª¨æ–™',
                'age': 'é¾„æœŸ'
            };
            return nameMap[name] || name;
        }
        
        // æ¸…ç©ºè¡¨å•
        function clearForm() {
            document.getElementById('query').value = '';
            document.getElementById('refIndex').value = '';
            document.getElementById('targetStrength').value = '';
            document.getElementById('cement').value = '';
            document.getElementById('bfs').value = '';
            document.getElementById('flyAsh').value = '';
            document.getElementById('water').value = '';
            document.getElementById('sp').value = '';
            document.getElementById('ca').value = '';
            document.getElementById('fa').value = '';
            document.getElementById('age').value = '';
            
            // å–æ¶ˆæ‰€æœ‰å¤é€‰æ¡†
            document.querySelectorAll('.checkbox-item input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            document.getElementById('result').innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">è¯·é…ç½®å‚æ•°å¹¶å‘é€è¯·æ±‚</p>';
        }
        
        // åŠ è½½ç¤ºä¾‹
        function loadExample() {
            // ç¤ºä¾‹1ï¼šå¹²é¢„åˆ†æ - æŒ‡å®šå˜é‡å’Œç›®æ ‡å¼ºåº¦
            document.getElementById('query').value = 'å¦‚ä½•é€šè¿‡è°ƒæ•´æ°´æ³¥å’Œç²‰ç…¤ç°ä½¿å¼ºåº¦è¾¾åˆ°45 MPaï¼Ÿ';
            document.getElementById('targetStrength').value = '45';
            
            // å‹¾é€‰è°ƒæ•´å˜é‡
            document.getElementById('adj_cement').checked = true;
            document.getElementById('adj_fly').checked = true;
            
            // è®¾ç½®è§‚æµ‹é…æ¯”
            document.getElementById('cement').value = '300';
            document.getElementById('bfs').value = '0';
            document.getElementById('flyAsh').value = '0';
            document.getElementById('water').value = '185';
            document.getElementById('sp').value = '3';
            document.getElementById('ca').value = '1050';
            document.getElementById('fa').value = '850';
            document.getElementById('age').value = '28';
            
            alert('âœ… å·²åŠ è½½ç¤ºä¾‹ï¼šå¹²é¢„åˆ†æ - é€šè¿‡è°ƒæ•´æ°´æ³¥å’Œç²‰ç…¤ç°è¾¾åˆ°ç›®æ ‡å¼ºåº¦');
        }
    </script>
</body>
</html>

