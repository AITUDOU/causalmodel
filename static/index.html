<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å› æœåˆ†ææ™ºèƒ½ä½“ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .reference-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .reference-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .samples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .sample-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
        }

        .sample-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .sample-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .sample-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .sample-card .param {
            font-size: 0.9em;
            color: #666;
            margin: 5px 0;
        }

        .sample-card .strength {
            font-weight: bold;
            color: #2ecc71;
            margin-top: 10px;
        }

        .query-section {
            margin-bottom: 30px;
        }

        .query-section h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .examples {
            background: #fff8e1;
            border-left: 4px solid #ffa726;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .examples h4 {
            color: #f57c00;
            margin-bottom: 10px;
        }

        .examples ul {
            list-style: none;
            padding-left: 0;
        }

        .examples li {
            padding: 5px 0;
            color: #666;
            cursor: pointer;
        }

        .examples li:hover {
            color: #667eea;
            text-decoration: underline;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }

        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .loading.active {
            display: block;
        }

        /* è¿›åº¦æ˜¾ç¤ºåŒºåŸŸ */
        .progress-section {
            display: none;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .progress-section.active {
            display: block;
        }

        .progress-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .progress-log {
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .progress-message {
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 5px;
            border-left: 3px solid #667eea;
            background: #f8f9fa;
            animation: fadeInSlide 0.3s ease-out;
        }

        .progress-message.start {
            background: #e8f5e9;
            border-left-color: #4caf50;
            font-weight: bold;
        }

        .progress-message.end {
            background: #e3f2fd;
            border-left-color: #2196f3;
            font-weight: bold;
        }

        .progress-message.error {
            background: #ffebee;
            border-left-color: #f44336;
            color: #c62828;
        }

        @keyframes fadeInSlide {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .result-section {
            display: none;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }

        .result-section.active {
            display: block;
        }

        .result-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .result-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .result-item h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .result-item pre {
            background: white;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 0.9em;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .badge-attribution {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-intervention {
            background: #fff3e0;
            color: #f57c00;
        }

        .badge-counterfactual {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 15px 30px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .predictor-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .predictor-section h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .param-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .param-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
        }

        .param-item label {
            display: block;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .param-item .param-info {
            font-size: 0.85em;
            color: #999;
            margin-bottom: 10px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider-container input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .slider-container input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .slider-container input[type="number"] {
            width: 80px;
            padding: 5px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            text-align: center;
        }

        .predict-result {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border-left: 5px solid #2ecc71;
        }

        .predict-result.active {
            display: block;
        }

        .strength-display {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .strength-display .value {
            font-size: 3em;
            font-weight: bold;
        }

        .strength-display .label {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .preset-configs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .preset-btn {
            padding: 10px 15px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .preset-btn:hover {
            background: #667eea;
            color: white;
        }

        .weights-chart {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }

        .weights-chart h4 {
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        .weight-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .weight-label {
            width: 150px;
            font-weight: bold;
            color: #333;
        }

        .weight-bar-container {
            flex: 1;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .weight-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
            transition: width 0.5s ease;
        }

        .weight-bar.positive {
            background: linear-gradient(90deg, #2ecc71 0%, #27ae60 100%);
        }

        .weight-bar.negative {
            background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
        }

        .weight-value {
            margin-left: 10px;
            width: 80px;
            text-align: right;
            font-weight: bold;
            color: #667eea;
        }

        .weight-effect {
            margin-left: 10px;
            font-size: 0.85em;
            color: #999;
        }

        /* ç›®æ ‡å¼ºåº¦æ»‘å—æ ·å¼ */
        #targetStrength::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 3px solid #667eea;
        }

        #targetStrength::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 3px solid #667eea;
        }

        /* å¤é€‰æ¡†æ ‡ç­¾é€‰ä¸­æ ·å¼ */
        .factor-checkbox-label input:checked + span {
            color: #667eea;
        }
        
        .factor-checkbox-label input:checked {
            accent-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ å› æœåˆ†ææ™ºèƒ½ä½“ç³»ç»Ÿ</h1>
            <p>æ··å‡åœŸé…åˆæ¯”è´¨é‡æ§åˆ¶ä¸ä¼˜åŒ–</p>
        </div>

        <div class="main-card">
            <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('predictor')">ğŸ”® å¼ºåº¦é¢„æµ‹</button>
                <button class="tab" onclick="switchTab('analysis')">ğŸ”¬ å› æœåˆ†æ</button>
            </div>

            <!-- å¼ºåº¦é¢„æµ‹æ ‡ç­¾é¡µ -->
            <div id="predictorTab" class="tab-content active">
                <div class="predictor-section">
                    <h3>ğŸ”® æ··å‡åœŸå¼ºåº¦é¢„æµ‹å™¨</h3>
                    <p style="color: #666; margin-bottom: 20px;">
                        è°ƒæ•´é…åˆæ¯”å‚æ•°ï¼Œå®æ—¶é¢„æµ‹æ··å‡åœŸæŠ—å‹å¼ºåº¦
                    </p>

                    <!-- é¢„è®¾é…ç½® -->
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #333; margin-bottom: 10px;">ğŸ’¡ å¿«é€Ÿé¢„è®¾</h4>
                        <div class="preset-configs">
                            <button class="preset-btn" onclick="applyPreset('c30')">C30 å¸¸è§„é…åˆæ¯”</button>
                            <button class="preset-btn" onclick="applyPreset('c40')">C40 ä¸­å¼ºé…åˆæ¯”</button>
                            <button class="preset-btn" onclick="applyPreset('c50')">C50 é«˜å¼ºé…åˆæ¯”</button>
                            <button class="preset-btn" onclick="applyPreset('lowwater')">ä½æ°´èƒ¶æ¯”é…åˆæ¯”</button>
                        </div>
                    </div>

                    <!-- å‚æ•°è¾“å…¥ -->
                    <div class="param-group">
                        <!-- æ°´æ³¥ -->
                        <div class="param-item">
                            <label>æ°´æ³¥ (Cement)</label>
                            <div class="param-info">èŒƒå›´: 100-600 kg/mÂ³</div>
                            <div class="slider-container">
                                <input type="range" id="cement" min="100" max="600" value="280" step="10" oninput="updateParamValue('cement')">
                                <input type="number" id="cementValue" min="100" max="600" value="280" oninput="updateParamSlider('cement')">
                            </div>
                        </div>

                        <!-- é«˜ç‚‰çŸ¿æ¸£ -->
                        <div class="param-item">
                            <label>é«˜ç‚‰çŸ¿æ¸£ (Blast Furnace Slag)</label>
                            <div class="param-info">èŒƒå›´: 0-400 kg/mÂ³</div>
                            <div class="slider-container">
                                <input type="range" id="slag" min="0" max="400" value="100" step="10" oninput="updateParamValue('slag')">
                                <input type="number" id="slagValue" min="0" max="400" value="100" oninput="updateParamSlider('slag')">
                            </div>
                        </div>

                        <!-- ç²‰ç…¤ç° -->
                        <div class="param-item">
                            <label>ç²‰ç…¤ç° (Fly Ash)</label>
                            <div class="param-info">èŒƒå›´: 0-250 kg/mÂ³</div>
                            <div class="slider-container">
                                <input type="range" id="flyash" min="0" max="250" value="50" step="10" oninput="updateParamValue('flyash')">
                                <input type="number" id="flyashValue" min="0" max="250" value="50" oninput="updateParamSlider('flyash')">
                            </div>
                        </div>

                        <!-- æ°´ -->
                        <div class="param-item">
                            <label>æ°´ (Water)</label>
                            <div class="param-info">èŒƒå›´: 100-300 kg/mÂ³</div>
                            <div class="slider-container">
                                <input type="range" id="water" min="100" max="300" value="180" step="5" oninput="updateParamValue('water')">
                                <input type="number" id="waterValue" min="100" max="300" value="180" oninput="updateParamSlider('water')">
                            </div>
                        </div>

                        <!-- é«˜æ•ˆå‡æ°´å‰‚ -->
                        <div class="param-item">
                            <label>é«˜æ•ˆå‡æ°´å‰‚ (Superplasticizer)</label>
                            <div class="param-info">èŒƒå›´: 0-40 kg/mÂ³</div>
                            <div class="slider-container">
                                <input type="range" id="sp" min="0" max="40" value="8" step="1" oninput="updateParamValue('sp')">
                                <input type="number" id="spValue" min="0" max="40" value="8" oninput="updateParamSlider('sp')">
                            </div>
                        </div>

                        <!-- ç²—éª¨æ–™ -->
                        <div class="param-item">
                            <label>ç²—éª¨æ–™ (Coarse Aggregate)</label>
                            <div class="param-info">èŒƒå›´: 700-1200 kg/mÂ³</div>
                            <div class="slider-container">
                                <input type="range" id="coarse" min="700" max="1200" value="1000" step="10" oninput="updateParamValue('coarse')">
                                <input type="number" id="coarseValue" min="700" max="1200" value="1000" oninput="updateParamSlider('coarse')">
                            </div>
                        </div>

                        <!-- ç»†éª¨æ–™ -->
                        <div class="param-item">
                            <label>ç»†éª¨æ–™ (Fine Aggregate)</label>
                            <div class="param-info">èŒƒå›´: 500-1100 kg/mÂ³</div>
                            <div class="slider-container">
                                <input type="range" id="fine" min="500" max="1100" value="800" step="10" oninput="updateParamValue('fine')">
                                <input type="number" id="fineValue" min="500" max="1100" value="800" oninput="updateParamSlider('fine')">
                            </div>
                        </div>

                        <!-- é¾„æœŸ -->
                        <div class="param-item">
                            <label>é¾„æœŸ (Age)</label>
                            <div class="param-info">èŒƒå›´: 1-365 å¤©</div>
                            <div class="slider-container">
                                <input type="range" id="age" min="1" max="365" value="28" step="1" oninput="updateParamValue('age')">
                                <input type="number" id="ageValue" min="1" max="365" value="28" oninput="updateParamSlider('age')">
                            </div>
                        </div>
                    </div>

                    <!-- é¢„æµ‹æŒ‰é’® -->
                    <button class="btn" onclick="predictStrength()">
                        ğŸš€ é¢„æµ‹å¼ºåº¦
                    </button>

                    <!-- é¢„æµ‹ç»“æœ -->
                    <div id="predictResult" class="predict-result">
                        <!-- å¿«æ·æ“ä½œæŒ‰é’® -->
                        <div style="text-align: center; margin-bottom: 15px;">
                            <button class="preset-btn" onclick="useCurrentConfigForAnalysis()" style="width: auto; padding: 10px 30px;">
                                ğŸ”¬ åŸºäºæ­¤é…æ¯”è¿›è¡Œåäº‹å®åˆ†æ
                            </button>
                        </div>
                        <div class="strength-display">
                            <div class="label">é¢„æµ‹æŠ—å‹å¼ºåº¦</div>
                            <div class="value" id="predictedStrength">--</div>
                            <div class="label">MPa</div>
                        </div>
                        <div id="predictInterpretation" style="white-space: pre-line; color: #333; line-height: 1.6;"></div>
                        
                        <!-- æƒé‡å›¾ -->
                        <div id="weightsChart" class="weights-chart" style="display: none;">
                            <h4>ğŸ“Š æ··å‡åœŸå¼ºåº¦å½±å“å› ç´ æƒé‡åˆ†æ</h4>
                            <p style="color: #666; text-align: center; margin-bottom: 20px; font-size: 0.9em;">
                                åŸºäºå› æœæ¨æ–­çš„ç‰¹å¾é‡è¦æ€§åˆ†æï¼ˆçº¿æ¡ç²—ç»†ä»£è¡¨æƒé‡å¤§å°ï¼Œé¢œè‰²ä»£è¡¨è´¨é‡è¯„åˆ†ï¼‰
                            </p>
                            <div id="weightsContainer"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å› æœåˆ†ææ ‡ç­¾é¡µ -->
            <div id="analysisTab" class="tab-content">
            
            <!-- æ­¥éª¤1: åŸºå‡†é…æ¯” -->
            <div class="predictor-section" style="margin-bottom: 25px;">
                <h3>ğŸ“‹ æ­¥éª¤1ï¼šè®¾ç½®åŸºå‡†é…æ¯”</h3>
                <p style="color: #666; margin-bottom: 15px;">
                    é€‰æ‹©ä¸€ä¸ªé¢„è®¾é…æ¯”ï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥æ‚¨çš„å½“å‰é…æ¯”
                </p>

                <!-- é¢„è®¾é…ç½® -->
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #333; margin-bottom: 10px;">ğŸ’¡ å¿«é€Ÿé¢„è®¾</h4>
                    <div class="preset-configs">
                        <button class="preset-btn" onclick="applyAnalysisPreset('c30')">C30 å¸¸è§„é…åˆæ¯”</button>
                        <button class="preset-btn" onclick="applyAnalysisPreset('c40')">C40 ä¸­å¼ºé…åˆæ¯”</button>
                        <button class="preset-btn" onclick="applyAnalysisPreset('c50')">C50 é«˜å¼ºé…åˆæ¯”</button>
                        <button class="preset-btn" onclick="applyAnalysisPreset('lowwater')">ä½æ°´èƒ¶æ¯”é…åˆæ¯”</button>
                    </div>
                </div>

                <!-- ç®€åŒ–çš„é…æ¯”è¾“å…¥ -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div style="background: white; padding: 12px; border-radius: 8px;">
                        <label style="font-weight: bold; color: #333; margin-bottom: 5px; display: block; font-size: 0.9em;">æ°´æ³¥ (kg/mÂ³)</label>
                        <input type="number" id="analysisCement" min="100" max="600" value="300" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px;">
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 8px;">
                        <label style="font-weight: bold; color: #333; margin-bottom: 5px; display: block; font-size: 0.9em;">çŸ¿æ¸£ (kg/mÂ³)</label>
                        <input type="number" id="analysisSlag" min="0" max="400" value="0" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px;">
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 8px;">
                        <label style="font-weight: bold; color: #333; margin-bottom: 5px; display: block; font-size: 0.9em;">ç²‰ç…¤ç° (kg/mÂ³)</label>
                        <input type="number" id="analysisFlyash" min="0" max="250" value="0" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px;">
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 8px;">
                        <label style="font-weight: bold; color: #333; margin-bottom: 5px; display: block; font-size: 0.9em;">æ°´ (kg/mÂ³)</label>
                        <input type="number" id="analysisWater" min="100" max="300" value="185" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px;">
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 8px;">
                        <label style="font-weight: bold; color: #333; margin-bottom: 5px; display: block; font-size: 0.9em;">å‡æ°´å‰‚ (kg/mÂ³)</label>
                        <input type="number" id="analysisSp" min="0" max="40" value="3" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px;">
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 8px;">
                        <label style="font-weight: bold; color: #333; margin-bottom: 5px; display: block; font-size: 0.9em;">ç²—éª¨æ–™ (kg/mÂ³)</label>
                        <input type="number" id="analysisCoarse" min="700" max="1200" value="1050" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px;">
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 8px;">
                        <label style="font-weight: bold; color: #333; margin-bottom: 5px; display: block; font-size: 0.9em;">ç»†éª¨æ–™ (kg/mÂ³)</label>
                        <input type="number" id="analysisFine" min="500" max="1100" value="850" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px;">
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 8px;">
                        <label style="font-weight: bold; color: #333; margin-bottom: 5px; display: block; font-size: 0.9em;">é¾„æœŸ (å¤©)</label>
                        <input type="number" id="analysisAge" min="1" max="365" value="28" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px;">
                    </div>
                </div>

                <!-- é¢„æµ‹åŸºå‡†å¼ºåº¦æŒ‰é’® -->
                <button class="btn" onclick="predictBaseStrength()" style="margin-bottom: 15px;">
                    ğŸ”® é¢„æµ‹åŸºå‡†å¼ºåº¦
                </button>

                <!-- åŸºå‡†å¼ºåº¦æ˜¾ç¤º -->
                <div id="baseStrengthDisplay" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.2em; margin-bottom: 10px;">å½“å‰é…æ¯”é¢„æµ‹å¼ºåº¦</div>
                    <div style="font-size: 3em; font-weight: bold;" id="baseStrengthValue">--</div>
                    <div style="font-size: 1.2em;">MPa</div>
                </div>
            </div>

            <!-- æ­¥éª¤2: ç›®æ ‡å¼ºåº¦ -->
            <div id="step2Section" class="predictor-section" style="margin-bottom: 25px; display: none;">
                <h3>ğŸ¯ æ­¥éª¤2ï¼šè®¾ç½®ç›®æ ‡å¼ºåº¦</h3>
                <p style="color: #666; margin-bottom: 15px;">
                    æ»‘åŠ¨é€‰æ‹©æ‚¨å¸Œæœ›è¾¾åˆ°çš„æ··å‡åœŸæŠ—å‹å¼ºåº¦ï¼ˆåŸºäºå½“å‰å¼ºåº¦ï¼š<span id="baseStrengthHint" style="color: #667eea; font-weight: bold;">--</span> MPaï¼‰
                </p>
                
                <div style="background: white; padding: 20px; border-radius: 10px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 3em; font-weight: bold; color: #667eea;" id="targetStrengthDisplay">45</div>
                        <div style="font-size: 1.2em; color: #666;">MPa</div>
                </div>
                    
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="color: #999;">20</span>
                        <input type="range" id="targetStrength" min="20" max="80" value="45" step="1" 
                               oninput="document.getElementById('targetStrengthDisplay').textContent = this.value"
                               style="flex: 1; height: 8px; border-radius: 4px; background: linear-gradient(90deg, #e74c3c 0%, #f39c12 25%, #2ecc71 50%, #3498db 100%); outline: none; -webkit-appearance: none;">
                        <span style="color: #999;">80</span>
            </div>

                    <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.85em; color: #999;">
                        <span>ä½å¼ºåº¦</span>
                        <span>ä¸­å¼ºåº¦</span>
                        <span>é«˜å¼ºåº¦</span>
                    </div>
                </div>
            </div>

            <!-- æ­¥éª¤3: é€‰æ‹©è°ƒæ•´å› ç´  -->
            <div id="step3Section" class="predictor-section" style="margin-bottom: 25px; display: none;">
                <h3>ğŸ”§ æ­¥éª¤3ï¼šé€‰æ‹©è¦è°ƒæ•´çš„å› ç´ ï¼ˆå¯å¤šé€‰ï¼‰</h3>
                <p style="color: #666; margin-bottom: 15px;">
                    å‹¾é€‰æ‚¨å¸Œæœ›ç³»ç»Ÿè‡ªåŠ¨è°ƒæ•´çš„é…æ¯”å‚æ•°
                </p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <label class="factor-checkbox-label" style="background: white; padding: 15px; border-radius: 8px; cursor: pointer; border: 2px solid #e0e0e0; display: flex; align-items: center; gap: 10px; transition: all 0.3s;"
                           onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#667eea'" 
                           onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e0e0e0'"
                           onclick="setTimeout(() => { this.style.borderColor = this.querySelector('input').checked ? '#667eea' : '#e0e0e0'; this.style.background = this.querySelector('input').checked ? '#f0f4ff' : 'white'; }, 10)">
                        <input type="checkbox" name="adjustFactor" value="cement" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: bold; color: #333;">ğŸ’ æ°´æ³¥</span>
                    </label>
                    
                    <label class="factor-checkbox-label" style="background: white; padding: 15px; border-radius: 8px; cursor: pointer; border: 2px solid #e0e0e0; display: flex; align-items: center; gap: 10px; transition: all 0.3s;"
                           onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#667eea'" 
                           onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e0e0e0'"
                           onclick="setTimeout(() => { this.style.borderColor = this.querySelector('input').checked ? '#667eea' : '#e0e0e0'; this.style.background = this.querySelector('input').checked ? '#f0f4ff' : 'white'; }, 10)">
                        <input type="checkbox" name="adjustFactor" value="blast_furnace_slag" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: bold; color: #333;">ğŸ­ é«˜ç‚‰çŸ¿æ¸£</span>
                    </label>
                    
                    <label class="factor-checkbox-label" style="background: white; padding: 15px; border-radius: 8px; cursor: pointer; border: 2px solid #e0e0e0; display: flex; align-items: center; gap: 10px; transition: all 0.3s;"
                           onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#667eea'" 
                           onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e0e0e0'"
                           onclick="setTimeout(() => { this.style.borderColor = this.querySelector('input').checked ? '#667eea' : '#e0e0e0'; this.style.background = this.querySelector('input').checked ? '#f0f4ff' : 'white'; }, 10)">
                        <input type="checkbox" name="adjustFactor" value="fly_ash" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: bold; color: #333;">ğŸŒ‹ ç²‰ç…¤ç°</span>
                    </label>
                    
                    <label class="factor-checkbox-label" style="background: white; padding: 15px; border-radius: 8px; cursor: pointer; border: 2px solid #e0e0e0; display: flex; align-items: center; gap: 10px; transition: all 0.3s;"
                           onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#667eea'" 
                           onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e0e0e0'"
                           onclick="setTimeout(() => { this.style.borderColor = this.querySelector('input').checked ? '#667eea' : '#e0e0e0'; this.style.background = this.querySelector('input').checked ? '#f0f4ff' : 'white'; }, 10)">
                        <input type="checkbox" name="adjustFactor" value="water" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: bold; color: #333;">ğŸ’§ æ°´</span>
                    </label>
                    
                    <label class="factor-checkbox-label" style="background: white; padding: 15px; border-radius: 8px; cursor: pointer; border: 2px solid #e0e0e0; display: flex; align-items: center; gap: 10px; transition: all 0.3s;"
                           onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#667eea'" 
                           onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e0e0e0'"
                           onclick="setTimeout(() => { this.style.borderColor = this.querySelector('input').checked ? '#667eea' : '#e0e0e0'; this.style.background = this.querySelector('input').checked ? '#f0f4ff' : 'white'; }, 10)">
                        <input type="checkbox" name="adjustFactor" value="superplasticizer" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: bold; color: #333;">âš—ï¸ é«˜æ•ˆå‡æ°´å‰‚</span>
                    </label>
                    
                    <label class="factor-checkbox-label" style="background: white; padding: 15px; border-radius: 8px; cursor: pointer; border: 2px solid #e0e0e0; display: flex; align-items: center; gap: 10px; transition: all 0.3s;"
                           onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#667eea'" 
                           onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e0e0e0'"
                           onclick="setTimeout(() => { this.style.borderColor = this.querySelector('input').checked ? '#667eea' : '#e0e0e0'; this.style.background = this.querySelector('input').checked ? '#f0f4ff' : 'white'; }, 10)">
                        <input type="checkbox" name="adjustFactor" value="coarse_aggregate" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: bold; color: #333;">ğŸª¨ ç²—éª¨æ–™</span>
                    </label>
                    
                    <label class="factor-checkbox-label" style="background: white; padding: 15px; border-radius: 8px; cursor: pointer; border: 2px solid #e0e0e0; display: flex; align-items: center; gap: 10px; transition: all 0.3s;"
                           onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#667eea'" 
                           onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e0e0e0'"
                           onclick="setTimeout(() => { this.style.borderColor = this.querySelector('input').checked ? '#667eea' : '#e0e0e0'; this.style.background = this.querySelector('input').checked ? '#f0f4ff' : 'white'; }, 10)">
                        <input type="checkbox" name="adjustFactor" value="fine_aggregate" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: bold; color: #333;">â›±ï¸ ç»†éª¨æ–™</span>
                    </label>
                    
                    <label class="factor-checkbox-label" style="background: white; padding: 15px; border-radius: 8px; cursor: pointer; border: 2px solid #e0e0e0; display: flex; align-items: center; gap: 10px; transition: all 0.3s;"
                           onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#667eea'" 
                           onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e0e0e0'"
                           onclick="setTimeout(() => { this.style.borderColor = this.querySelector('input').checked ? '#667eea' : '#e0e0e0'; this.style.background = this.querySelector('input').checked ? '#f0f4ff' : 'white'; }, 10)">
                        <input type="checkbox" name="adjustFactor" value="age" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: bold; color: #333;">â° é¾„æœŸ</span>
                    </label>
                </div>

                <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px;">
                    <strong>ğŸ’¡ æç¤ºï¼š</strong> å»ºè®®é€‰æ‹©2-3ä¸ªå› ç´ è¿›è¡Œè°ƒæ•´ï¼Œä»¥è·å¾—æ›´å®ç”¨çš„ä¼˜åŒ–æ–¹æ¡ˆ
                </div>

                <!-- å¼€å§‹ä¼˜åŒ–æŒ‰é’® -->
                <button class="btn" onclick="startOptimization()" style="font-size: 1.2em; padding: 18px;">
                    ğŸš€ å¼€å§‹æ™ºèƒ½ä¼˜åŒ–
                </button>
            </div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loading" class="loading">
                <p>â³ åˆ†æä¸­ï¼Œè¯·ç¨å€™...</p>
                <p style="font-size: 0.9em; margin-top: 10px;">è¿™å¯èƒ½éœ€è¦5-30ç§’</p>
            </div>

            <!-- è¿›åº¦æ˜¾ç¤º -->
            <div id="progressSection" class="progress-section">
                <h3>ğŸ“¡ å®æ—¶åˆ†æè¿›åº¦</h3>
                <div id="progressLog" class="progress-log"></div>
            </div>

            <!-- ç»“æœå±•ç¤º -->
            <div id="resultSection" class="result-section">
                <div class="result-header">
                    <h2>ğŸ“Š åˆ†æç»“æœ</h2>
                </div>

                <div class="result-item">
                    <h4>ğŸ¯ åˆ†æç±»å‹</h4>
                    <p id="analysisType">-</p>
                </div>

                <div class="result-item">
                    <h4>ğŸ“ˆ ç›®æ ‡å˜é‡</h4>
                    <p id="targetVariable">-</p>
                </div>

                <div class="result-item">
                    <h4>ğŸ“ åˆ†ææ‘˜è¦</h4>
                    <p id="analysisSummary">-</p>
                </div>

                <div id="optimizedConfigSection" class="result-item" style="display: none; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%); border-left: 5px solid #4caf50;">
                    <h4>ğŸ¯ ä¼˜åŒ–é…æ¯”æ–¹æ¡ˆ</h4>
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 10px;">
                        <p style="font-weight: bold; color: #2e7d32; margin-bottom: 10px;">
                            é¢„æµ‹å¼ºåº¦: <span id="optimizedStrength" style="font-size: 1.5em;">--</span> MPa
                        </p>
                        <pre id="optimizationSummary" style="background: #f5f5f5; padding: 10px; border-radius: 5px; white-space: pre-line;">-</pre>
                    </div>
                </div>

                <div class="result-item">
                    <h4>ğŸ’¡ å†³ç­–å»ºè®®</h4>
                    <pre id="recommendations">-</pre>
                </div>

                <div class="result-item">
                    <h4>ğŸ“Š è¯¦ç»†ç»“æœ</h4>
                    <pre id="detailedResults">-</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedSampleIndex = null;
        let currentObservedConfig = null;  // å­˜å‚¨å½“å‰é…æ¯”
        const API_BASE = 'http://localhost:8000';

        // é¡µé¢åŠ è½½æ—¶è·å–å‚è€ƒæ‰¹æ¬¡
        window.addEventListener('load', async () => {
            await loadSamples();
        });

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰activeç±»
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾
            if (tabName === 'predictor') {
                document.querySelector('.tab:first-child').classList.add('active');
                document.getElementById('predictorTab').classList.add('active');
            } else if (tabName === 'analysis') {
                document.querySelector('.tab:last-child').classList.add('active');
                document.getElementById('analysisTab').classList.add('active');
                // åˆ‡æ¢åˆ°åˆ†æé¡µé¢æ—¶ï¼ŒåŒæ­¥é…æ¯”æ•°æ®
                syncConfigToAnalysis();
            }
        }

        // æ›´æ–°å‚æ•°å€¼ï¼ˆä»æ»‘åŠ¨æ¡ï¼‰
        function updateParamValue(paramName) {
            const slider = document.getElementById(paramName);
            const input = document.getElementById(paramName + 'Value');
            input.value = slider.value;
        }

        // æ›´æ–°æ»‘åŠ¨æ¡ï¼ˆä»è¾“å…¥æ¡†ï¼‰
        function updateParamSlider(paramName) {
            const slider = document.getElementById(paramName);
            const input = document.getElementById(paramName + 'Value');
            slider.value = input.value;
        }

        // åº”ç”¨é¢„è®¾é…ç½®
        function applyPreset(presetName) {
            const presets = {
                'c30': {
                    cement: 300,
                    slag: 0,
                    flyash: 0,
                    water: 185,
                    sp: 3,
                    coarse: 1050,
                    fine: 850,
                    age: 28
                },
                'c40': {
                    cement: 380,
                    slag: 50,
                    flyash: 30,
                    water: 170,
                    sp: 8,
                    coarse: 1000,
                    fine: 800,
                    age: 28
                },
                'c50': {
                    cement: 450,
                    slag: 100,
                    flyash: 50,
                    water: 160,
                    sp: 12,
                    coarse: 980,
                    fine: 780,
                    age: 28
                },
                'lowwater': {
                    cement: 400,
                    slag: 150,
                    flyash: 80,
                    water: 150,
                    sp: 15,
                    coarse: 950,
                    fine: 750,
                    age: 28
                }
            };

            const preset = presets[presetName];
            if (preset) {
                // è®¾ç½®æ‰€æœ‰å‚æ•°
                Object.keys(preset).forEach(key => {
                    document.getElementById(key).value = preset[key];
                    document.getElementById(key + 'Value').value = preset[key];
                });
            }
        }

        // æ˜¾ç¤ºæƒé‡å›¾
        function displayWeightsChart(weights) {
            const container = document.getElementById('weightsContainer');
            const chartDiv = document.getElementById('weightsChart');
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰æƒé‡æ’åº
            const weightArray = Object.entries(weights).map(([key, value]) => ({
                key: key,
                ...value
            })).sort((a, b) => b.weight_pct - a.weight_pct);
            
            // æ‰¾å‡ºæœ€å¤§æƒé‡ç”¨äºå½’ä¸€åŒ–
            const maxWeight = Math.max(...weightArray.map(w => w.weight_pct));
            
            // åˆ›å»ºæƒé‡æ¡
            weightArray.forEach(weight => {
                const item = document.createElement('div');
                item.className = 'weight-item';
                
                const barClass = weight.causal_effect >= 0 ? 'positive' : 'negative';
                const direction = weight.causal_effect >= 0 ? 'â†‘' : 'â†“';
                
                item.innerHTML = `
                    <div class="weight-label">${weight.name}</div>
                    <div class="weight-bar-container">
                        <div class="weight-bar ${barClass}" style="width: ${(weight.weight_pct / maxWeight * 100)}%">
                            ${weight.weight_pct.toFixed(1)}%
                        </div>
                    </div>
                    <div class="weight-value">${direction} ${Math.abs(weight.causal_effect).toFixed(2)}</div>
                    <div class="weight-effect">è¯„åˆ†: ${weight.score}</div>
                `;
                
                container.appendChild(item);
            });
            
            // æ˜¾ç¤ºæƒé‡å›¾
            chartDiv.style.display = 'block';
        }

        // é¢„æµ‹åŸºå‡†å¼ºåº¦
        let cachedBaseStrength = null;  // ç¼“å­˜åŸºå‡†å¼ºåº¦

        async function predictBaseStrength() {
            // è·å–é…æ¯”
            const baseConfig = {
                cement: parseFloat(document.getElementById('analysisCement').value),
                blast_furnace_slag: parseFloat(document.getElementById('analysisSlag').value),
                fly_ash: parseFloat(document.getElementById('analysisFlyash').value),
                water: parseFloat(document.getElementById('analysisWater').value),
                superplasticizer: parseFloat(document.getElementById('analysisSp').value),
                coarse_aggregate: parseFloat(document.getElementById('analysisCoarse').value),
                fine_aggregate: parseFloat(document.getElementById('analysisFine').value),
                age: parseInt(document.getElementById('analysisAge').value)
            };
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'â³ é¢„æµ‹ä¸­...';

            try {
                const response = await fetch(`${API_BASE}/api/predict`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(baseConfig)
                });

                const data = await response.json();

                if (data.success) {
                    const strength = data.predicted_strength;
                    cachedBaseStrength = strength;

                    // æ˜¾ç¤ºåŸºå‡†å¼ºåº¦
                    document.getElementById('baseStrengthValue').textContent = strength.toFixed(2);
                    document.getElementById('baseStrengthDisplay').style.display = 'block';
                    document.getElementById('baseStrengthHint').textContent = strength.toFixed(2);

                    // æ˜¾ç¤ºæ­¥éª¤2å’Œæ­¥éª¤3
                    document.getElementById('step2Section').style.display = 'block';
                    document.getElementById('step3Section').style.display = 'block';

                    // è®¾ç½®ç›®æ ‡å¼ºåº¦æ»‘å—
                    const targetSlider = document.getElementById('targetStrength');
                    const targetDisplay = document.getElementById('targetStrengthDisplay');
                    
                    // è®¾ç½®æœ€å°å€¼ä¸ºåŸºå‡†å¼ºåº¦ï¼Œæœ€å¤§å€¼ä¸º80æˆ–åŸºå‡†å¼ºåº¦+30
                    const minTarget = Math.max(20, Math.floor(strength));
                    const maxTarget = Math.min(80, Math.ceil(strength) + 30);
                    const defaultTarget = Math.min(Math.ceil(strength) + 10, maxTarget);

                    targetSlider.min = minTarget;
                    targetSlider.max = maxTarget;
                    targetSlider.value = defaultTarget;
                    targetDisplay.textContent = defaultTarget;

                    // æ»šåŠ¨åˆ°æ­¥éª¤2
                    setTimeout(() => {
                        document.getElementById('step2Section').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 300);
                } else {
                    alert('é¢„æµ‹å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }

            } catch (error) {
                console.error('é¢„æµ‹å¤±è´¥:', error);
                alert('é¢„æµ‹å¤±è´¥ï¼š' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ”® é¢„æµ‹åŸºå‡†å¼ºåº¦';
            }
        }

        // åº”ç”¨åˆ†æé¡µé¢çš„é¢„è®¾é…æ¯”
        function applyAnalysisPreset(presetName) {
            const presets = {
                'c30': {
                    cement: 300,
                    slag: 0,
                    flyash: 0,
                    water: 185,
                    sp: 3,
                    coarse: 1050,
                    fine: 850,
                    age: 28
                },
                'c40': {
                    cement: 380,
                    slag: 50,
                    flyash: 30,
                    water: 170,
                    sp: 8,
                    coarse: 1000,
                    fine: 800,
                    age: 28
                },
                'c50': {
                    cement: 450,
                    slag: 100,
                    flyash: 50,
                    water: 160,
                    sp: 12,
                    coarse: 980,
                    fine: 780,
                    age: 28
                },
                'lowwater': {
                    cement: 400,
                    slag: 150,
                    flyash: 80,
                    water: 150,
                    sp: 15,
                    coarse: 950,
                    fine: 750,
                    age: 28
                }
            };

            const preset = presets[presetName];
            if (preset) {
                document.getElementById('analysisCement').value = preset.cement;
                document.getElementById('analysisSlag').value = preset.slag;
                document.getElementById('analysisFlyash').value = preset.flyash;
                document.getElementById('analysisWater').value = preset.water;
                document.getElementById('analysisSp').value = preset.sp;
                document.getElementById('analysisCoarse').value = preset.coarse;
                document.getElementById('analysisFine').value = preset.fine;
                document.getElementById('analysisAge').value = preset.age;
            }
        }

        // å¼€å§‹æ™ºèƒ½ä¼˜åŒ–
        async function startOptimization() {
            // 1. è·å–åŸºå‡†é…æ¯”
            const baseConfig = {
                cement: parseFloat(document.getElementById('analysisCement').value),
                blast_furnace_slag: parseFloat(document.getElementById('analysisSlag').value),
                fly_ash: parseFloat(document.getElementById('analysisFlyash').value),
                water: parseFloat(document.getElementById('analysisWater').value),
                superplasticizer: parseFloat(document.getElementById('analysisSp').value),
                coarse_aggregate: parseFloat(document.getElementById('analysisCoarse').value),
                fine_aggregate: parseFloat(document.getElementById('analysisFine').value),
                age: parseInt(document.getElementById('analysisAge').value)
            };

            // 2. è·å–ç›®æ ‡å¼ºåº¦
            const targetStrength = parseFloat(document.getElementById('targetStrength').value);

            // 3. è·å–é€‰ä¸­çš„è°ƒæ•´å› ç´ 
            const checkedBoxes = document.querySelectorAll('input[name="adjustFactor"]:checked');
            const selectedFactors = Array.from(checkedBoxes).map(cb => cb.value);

            // éªŒè¯
            if (selectedFactors.length === 0) {
                alert('âŒ è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦è°ƒæ•´çš„å› ç´ ï¼');
                return;
            }

            console.log('åŸºå‡†é…æ¯”:', baseConfig);
            console.log('ç›®æ ‡å¼ºåº¦:', targetStrength);
            console.log('é€‰ä¸­å› ç´ :', selectedFactors);

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').classList.add('active');
            document.getElementById('progressSection').classList.add('active');
            document.getElementById('resultSection').classList.remove('active');
            const progressLog = document.getElementById('progressLog');
            progressLog.innerHTML = '';
            
            const optimizeBtn = document.querySelector('#analysisTab .btn');
            optimizeBtn.disabled = true;
            optimizeBtn.textContent = 'â³ ä¼˜åŒ–ä¸­...';

            try {
                addProgressMessage('ğŸš€ å¼€å§‹æ™ºèƒ½ä¼˜åŒ–...', 'start');
                addProgressMessage(`ğŸ¯ ç›®æ ‡å¼ºåº¦: ${targetStrength} MPa`, 'progress');
                addProgressMessage(`ğŸ”§ è°ƒæ•´å› ç´ : ${selectedFactors.join(', ')}`, 'progress');

                const response = await fetch(`${API_BASE}/api/optimize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        base_config: baseConfig,
                        target_strength: targetStrength,
                        adjust_factors: selectedFactors
                    })
                });

                const data = await response.json();

                if (data.success) {
                    addProgressMessage('âœ… ä¼˜åŒ–å®Œæˆ', 'end');
                    displayOptimizationResults(data);
                } else {
                    addProgressMessage('âŒ ä¼˜åŒ–å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                    alert('ä¼˜åŒ–å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }

            } catch (error) {
                console.error('ä¼˜åŒ–å¤±è´¥:', error);
                addProgressMessage('âŒ ä¼˜åŒ–å¤±è´¥: ' + error.message, 'error');
                alert('ä¼˜åŒ–å¤±è´¥ï¼š' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('active');
                optimizeBtn.disabled = false;
                optimizeBtn.textContent = 'ğŸš€ å¼€å§‹æ™ºèƒ½ä¼˜åŒ–';
            }
        }

        // æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
        function displayOptimizationResults(data) {
            // æ„å»ºä¼˜åŒ–ç»“æœæ˜¾ç¤º
            const varNameMap = {
                'cement': 'æ°´æ³¥',
                'blast_furnace_slag': 'é«˜ç‚‰çŸ¿æ¸£',
                'fly_ash': 'ç²‰ç…¤ç°',
                'water': 'æ°´',
                'superplasticizer': 'é«˜æ•ˆå‡æ°´å‰‚',
                'coarse_aggregate': 'ç²—éª¨æ–™',
                'fine_aggregate': 'ç»†éª¨æ–™',
                'age': 'é¾„æœŸ'
            };

            document.getElementById('analysisType').innerHTML = 
                '<span class="badge badge-intervention">æ™ºèƒ½ä¼˜åŒ–</span>';
            
            document.getElementById('targetVariable').textContent = 'concrete_compressive_strength (æŠ—å‹å¼ºåº¦)';
            
            document.getElementById('analysisSummary').textContent = 
                `åŸºå‡†å¼ºåº¦ ${data.base_strength} MPa â†’ ä¼˜åŒ–å¼ºåº¦ ${data.predicted_strength} MPa (${data.improvement_percent >= 0 ? '+' : ''}${data.improvement_percent}%)`;

            // æ˜¾ç¤ºä¼˜åŒ–é…æ¯”
            let optimizationHTML = `
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    <div style="background: white; padding: 15px; border-radius: 8px;">
        <h5 style="color: #999; margin-bottom: 10px;">åŸºå‡†é…æ¯”</h5>
        <div style="font-size: 2em; font-weight: bold; color: #e74c3c;">${data.base_strength} MPa</div>
    </div>
    <div style="background: white; padding: 15px; border-radius: 8px;">
        <h5 style="color: #999; margin-bottom: 10px;">ä¼˜åŒ–é…æ¯”</h5>
        <div style="font-size: 2em; font-weight: bold; color: #2ecc71;">${data.predicted_strength} MPa</div>
    </div>
</div>

<h5 style="color: #667eea; margin-bottom: 10px;">ğŸ“ é…æ¯”è°ƒæ•´è¯¦æƒ…</h5>
<table style="width: 100%; background: white; border-radius: 8px; overflow: hidden;">
    <thead style="background: #f8f9fa;">
        <tr>
            <th style="padding: 10px; text-align: left;">å‚æ•°</th>
            <th style="padding: 10px; text-align: center;">åŸºå‡†å€¼</th>
            <th style="padding: 10px; text-align: center;">ä¼˜åŒ–å€¼</th>
            <th style="padding: 10px; text-align: center;">å˜åŒ–</th>
        </tr>
    </thead>
    <tbody>
`;

            data.adjustments.forEach(adj => {
                const changeColor = adj.change_percent >= 0 ? '#2ecc71' : '#e74c3c';
                optimizationHTML += `
        <tr style="border-top: 1px solid #f0f0f0;">
            <td style="padding: 10px;">${adj.name}</td>
            <td style="padding: 10px; text-align: center;">${adj.old_value} kg/mÂ³</td>
            <td style="padding: 10px; text-align: center; font-weight: bold;">${adj.new_value} kg/mÂ³</td>
            <td style="padding: 10px; text-align: center; color: ${changeColor}; font-weight: bold;">
                ${adj.change_percent >= 0 ? '+' : ''}${adj.change_percent}%
            </td>
        </tr>
`;
            });

            optimizationHTML += `
    </tbody>
</table>

<h5 style="color: #667eea; margin: 20px 0 10px 0;">ğŸ“Š å®Œæ•´ä¼˜åŒ–é…æ¯”</h5>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
`;

            for (const [key, value] of Object.entries(data.optimized_config)) {
                const name = varNameMap[key] || key;
                optimizationHTML += `
    <div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid #667eea;">
        <div style="font-size: 0.9em; color: #999;">${name}</div>
        <div style="font-weight: bold; font-size: 1.1em;">${typeof value === 'number' ? value.toFixed(1) : value} ${key === 'age' ? 'å¤©' : 'kg/mÂ³'}</div>
    </div>
`;
            }

            optimizationHTML += '</div>';

            document.getElementById('optimizationSummary').innerHTML = optimizationHTML;
            document.getElementById('optimizedStrength').textContent = data.predicted_strength.toFixed(2);
            document.getElementById('optimizedConfigSection').style.display = 'block';

            document.getElementById('recommendations').textContent = data.recommendations;
            document.getElementById('detailedResults').textContent = JSON.stringify(data, null, 2);

            document.getElementById('resultSection').classList.add('active');
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }

        // åŒæ­¥é¢„æµ‹é¡µé¢çš„é…æ¯”åˆ°åˆ†æé¡µé¢
        function syncConfigToAnalysis() {
            if (currentObservedConfig) {
                document.getElementById('analysisCement').value = currentObservedConfig.cement;
                document.getElementById('analysisSlag').value = currentObservedConfig.blast_furnace_slag;
                document.getElementById('analysisFlyash').value = currentObservedConfig.fly_ash;
                document.getElementById('analysisWater').value = currentObservedConfig.water;
                document.getElementById('analysisSp').value = currentObservedConfig.superplasticizer;
                document.getElementById('analysisCoarse').value = currentObservedConfig.coarse_aggregate;
                document.getElementById('analysisFine').value = currentObservedConfig.fine_aggregate;
                document.getElementById('analysisAge').value = currentObservedConfig.age;
            }
        }

        // ä½¿ç”¨å½“å‰é…æ¯”è¿›è¡Œåäº‹å®åˆ†æ
        function useCurrentConfigForAnalysis() {
            if (!currentObservedConfig) {
                alert('è¯·å…ˆè¿›è¡Œä¸€æ¬¡å¼ºåº¦é¢„æµ‹');
                return;
            }
            
            // åˆ‡æ¢åˆ°åˆ†ææ ‡ç­¾é¡µï¼ˆä¼šè‡ªåŠ¨åŒæ­¥é…æ¯”ï¼‰
            switchTab('analysis');
            
            // å¡«å……ç¤ºä¾‹é—®é¢˜
            const water = currentObservedConfig.water;
            const newWater = Math.max(100, water - 20);
            document.getElementById('queryInput').value = 
                `å¦‚æœæ°´ç”¨é‡ä»${water}é™åˆ°${newWater} kg/mÂ³ï¼Œå¼ºåº¦ä¼šæå‡å¤šå°‘ï¼Ÿ`;
            
            // é«˜äº®æç¤º
            setTimeout(() => {
                alert('âœ… å·²åŒæ­¥é¢„æµ‹é¡µé¢çš„é…æ¯”ï¼Œæ‚¨å¯ä»¥ç›´æ¥æé—®æˆ–ä¿®æ”¹é…æ¯”å‚æ•°');
            }, 300);
            
            // æ»šåŠ¨åˆ°æŸ¥è¯¢åŒºåŸŸ
            setTimeout(() => {
                document.getElementById('queryInput').scrollIntoView({ behavior: 'smooth' });
            }, 500);
        }

        // é¢„æµ‹å¼ºåº¦
        async function predictStrength() {
            const params = {
                cement: parseFloat(document.getElementById('cementValue').value),
                blast_furnace_slag: parseFloat(document.getElementById('slagValue').value),
                fly_ash: parseFloat(document.getElementById('flyashValue').value),
                water: parseFloat(document.getElementById('waterValue').value),
                superplasticizer: parseFloat(document.getElementById('spValue').value),
                coarse_aggregate: parseFloat(document.getElementById('coarseValue').value),
                fine_aggregate: parseFloat(document.getElementById('fineValue').value),
                age: parseInt(document.getElementById('ageValue').value)
            };
            
            // ä¿å­˜å½“å‰é…æ¯”ï¼ˆç”¨äºåäº‹å®åˆ†æï¼‰
            currentObservedConfig = params;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const btn = document.querySelector('#predictorTab .btn');
            btn.disabled = true;
            btn.textContent = 'â³ é¢„æµ‹ä¸­...';

            try {
                const response = await fetch(`${API_BASE}/api/predict`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const data = await response.json();

                if (data.success) {
                    // æ˜¾ç¤ºé¢„æµ‹ç»“æœ
                    document.getElementById('predictedStrength').textContent = data.predicted_strength.toFixed(2);
                    document.getElementById('predictInterpretation').textContent = data.interpretation;
                    document.getElementById('predictResult').classList.add('active');

                    // æ˜¾ç¤ºæƒé‡å›¾
                    if (data.feature_weights) {
                        displayWeightsChart(data.feature_weights);
                    }

                    // æ»šåŠ¨åˆ°ç»“æœ
                    document.getElementById('predictResult').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    alert('é¢„æµ‹å¤±è´¥: ' + data.error);
                }

            } catch (error) {
                console.error('é¢„æµ‹å¤±è´¥:', error);
                alert('é¢„æµ‹å¤±è´¥ï¼š' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸš€ é¢„æµ‹å¼ºåº¦';
            }
        }

        // åŠ è½½å‚è€ƒæ‰¹æ¬¡
        async function loadSamples() {
            try {
                const response = await fetch(`${API_BASE}/api/samples`);
                const data = await response.json();
                
                const samplesGrid = document.getElementById('samplesGrid');
                samplesGrid.innerHTML = '';
                
                const categoryNames = {
                    'low': 'ğŸ”´ ä½å¼ºåº¦æ‰¹æ¬¡',
                    'medium': 'ğŸŸ¡ ä¸­ç­‰å¼ºåº¦æ‰¹æ¬¡',
                    'high': 'ğŸŸ¢ é«˜å¼ºåº¦æ‰¹æ¬¡',
                    'target': 'ğŸ¯ å›¾ç‰‡é…åˆæ¯”'
                };
                
                data.samples.forEach(sample => {
                    const card = document.createElement('div');
                    card.className = 'sample-card';
                    card.onclick = () => selectSample(sample.index, card);
                    
                    card.innerHTML = `
                        <h4 style="margin-bottom: 8px;">${categoryNames[sample.category]}</h4>
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 8px;">æ‰¹æ¬¡ç´¢å¼•: #${sample.index}</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 8px;">
                            <div class="param">æ°´æ³¥: ${sample.cement.toFixed(0)}</div>
                            <div class="param">çŸ¿æ¸£: ${sample.blast_furnace_slag.toFixed(0)}</div>
                            <div class="param">ç²‰ç…¤ç°: ${sample.fly_ash.toFixed(0)}</div>
                            <div class="param">æ°´: ${sample.water.toFixed(0)}</div>
                            <div class="param">å‡æ°´å‰‚: ${sample.superplasticizer.toFixed(1)}</div>
                            <div class="param">ç²—éª¨æ–™: ${sample.coarse_aggregate.toFixed(0)}</div>
                            <div class="param">ç»†éª¨æ–™: ${sample.fine_aggregate.toFixed(0)}</div>
                            <div class="param">é¾„æœŸ: ${sample.age}å¤©</div>
                        </div>
                        <div class="strength" style="text-align: center; padding-top: 8px; border-top: 1px solid #e0e0e0;">
                            å¼ºåº¦: ${sample.concrete_compressive_strength.toFixed(1)} MPa
                        </div>
                    `;
                    samplesGrid.appendChild(card);
                });
            } catch (error) {
                console.error('åŠ è½½æ ·æœ¬å¤±è´¥:', error);
                document.getElementById('samplesGrid').innerHTML = 
                    '<div style="color: red;">åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿APIæœåŠ¡å™¨å·²å¯åŠ¨</div>';
            }
        }

        // é€‰æ‹©æ ·æœ¬
        function selectSample(index, cardElement) {
            // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.sample-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            cardElement.classList.add('selected');
            selectedSampleIndex = index;
            
            console.log('å·²é€‰æ‹©æ‰¹æ¬¡:', index);
        }

        // å¡«å……ç¤ºä¾‹æŸ¥è¯¢
        function fillQuery(query) {
            document.getElementById('queryInput').value = query;
        }

        // æ‰§è¡Œåˆ†æï¼ˆå¸¦å‚æ•°ç‰ˆæœ¬ï¼‰
        async function analyzeQueryWithParams(query, observedConfig = null) {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€å’Œè¿›åº¦åŒºåŸŸ
            document.getElementById('loading').classList.add('active');
            document.getElementById('progressSection').classList.add('active');
            document.getElementById('resultSection').classList.remove('active');
            const progressLog = document.getElementById('progressLog');
            progressLog.innerHTML = '';
            
            const analyzeBtn = document.querySelector('#analysisTab .btn');
            analyzeBtn.disabled = true;

            try {
                const payload = {
                    query: query,
                    reference_sample_index: null,  // ä¸ä½¿ç”¨å‚è€ƒæ ·æœ¬
                    observed_config: observedConfig || currentObservedConfig
                };

                console.log('å‘é€æµå¼è¯·æ±‚:', payload);

                // ä½¿ç”¨fetchå‘é€POSTè¯·æ±‚ï¼Œç„¶åè¯»å–æµå¼å“åº”
                const response = await fetch(`${API_BASE}/api/analyze_stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let finalData = null;

                while (true) {
                    const { value, done } = await reader.read();
                    
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    
                    // å¤„ç†SSEæ ¼å¼çš„æ•°æ®
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop(); // ä¿ç•™ä¸å®Œæ•´çš„è¡Œ
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const jsonData = JSON.parse(line.substring(6));
                                
                                if (jsonData.type === 'start') {
                                    addProgressMessage('ğŸš€ ' + jsonData.message, 'start');
                                } else if (jsonData.type === 'progress') {
                                    addProgressMessage(jsonData.message, 'progress');
                                } else if (jsonData.type === 'result') {
                                    finalData = jsonData.data;
                                } else if (jsonData.type === 'end') {
                                    addProgressMessage('âœ… ' + jsonData.message, 'end');
                                } else if (jsonData.type === 'error') {
                                    addProgressMessage('âŒ ' + jsonData.message, 'error');
                                }
                            } catch (e) {
                                console.warn('è§£æSSEæ¶ˆæ¯å¤±è´¥:', e, line);
                            }
                        }
                    }
                }

                // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
                if (finalData) {
                    displayResults(finalData);
                } else {
                    alert('æœªæ”¶åˆ°åˆ†æç»“æœ');
                }

            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                addProgressMessage('âŒ åˆ†æå¤±è´¥: ' + error.message, 'error');
            } finally {
                document.getElementById('loading').classList.remove('active');
                analyzeBtn.disabled = false;
            }
        }
        
        // æ·»åŠ è¿›åº¦æ¶ˆæ¯
        function addProgressMessage(message, type = 'progress') {
            const progressLog = document.getElementById('progressLog');
            const msgDiv = document.createElement('div');
            msgDiv.className = `progress-message ${type}`;
            msgDiv.textContent = message;
            progressLog.appendChild(msgDiv);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            progressLog.scrollTop = progressLog.scrollHeight;
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(data) {
            const analysisTypeMap = {
                'attribution': 'å½’å› åˆ†æ',
                'intervention': 'å¹²é¢„åˆ†æ',
                'counterfactual': 'åäº‹å®åˆ†æ'
            };

            const badgeClass = `badge-${data.analysis_type}`;
            
            document.getElementById('analysisType').innerHTML = 
                `<span class="badge ${badgeClass}">${analysisTypeMap[data.analysis_type]}</span>`;
            
            document.getElementById('targetVariable').textContent = data.target_variable;
            document.getElementById('analysisSummary').textContent = data.analysis_summary;
            document.getElementById('recommendations').textContent = data.recommendations;
            document.getElementById('detailedResults').textContent = 
                JSON.stringify(data.causal_results, null, 2);

            // æ˜¾ç¤ºä¼˜åŒ–é…æ¯”ï¼ˆå¦‚æœæœ‰ï¼‰
            if (data.optimized_config && data.predicted_strength) {
                document.getElementById('optimizedStrength').textContent = data.predicted_strength.toFixed(2);
                document.getElementById('optimizationSummary').textContent = data.optimization_summary || '';
                document.getElementById('optimizedConfigSection').style.display = 'block';
            } else {
                document.getElementById('optimizedConfigSection').style.display = 'none';
            }

            document.getElementById('resultSection').classList.add('active');
            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>

